function csrfSafeMethod(e){return/^(GET|HEAD|OPTIONS|TRACE)$/.test(e)}function Graph(e){var t=this;t.items=e;var n=$("form.settings-form");t.settings=n.serializeObject();$("input, select",n).bind("change",function(){t.update(n.serializeObject())})}function extract_sentences(e){var t=[];e.forEach(function(e){e.sentences.forEach(function(n){n.paragraph=e;t.push(n)})});return t}function generate_scores(e,t){function r(e,n){e.score=1;var r=t[n+"_threshold_max"],i=t[n+"_threshold_min"],s=e.words.length;e.sentences&&(s=e.sentences.length);s<i&&(e.score+=s-i);s>r&&(e.score+=r-s);e.sentences&&e.sentences.forEach(function(t){e.score+=t.score});e.score+=e.active_words-e.passive_words}function i(e){e.wordScore=0;if(!t.words)return;e.words.forEach(function(n){t.words.indexOf(n)>=0&&e.wordScore++})}var n=extract_sentences(e);t.sentences_threshold_min||(t.sentences_threshold_min=d3.min(e,function(e){return e.sentences.length}));t.sentences_threshold_max||(t.sentences_threshold_max=d3.max(e,function(e){return e.sentences.length}));t.words_threshold_min||(t.words_threshold_min=d3.min(n,function(e){return e.words.length}));t.words_threshold_max||(t.words_threshold_max=d3.max(n,function(e){return e.words.length}));e.forEach(function(e){e.sentences.forEach(function(e){r(e,"words");i(e)});r(e,"sentences");i(e)});var s=d3.max(e,function(e){return e.score})*t.correct_percent,o=d3.max(e,function(e){return e.score})*t.correct_percent;e.forEach(function(e){e.score>s&&(e.score=s);e.sentences.forEach(function(e){e.score>o&&(e.score=o)})});return e}function showTooltip(e){var t=$("#viz-pane");$(".score .value").data("value",e.score).html(e.score)}function hideTooltip(e){}function hoverSentence(e){$("#viz-pane .score .value").html(e.score);var t=$("#viz-pane .words").html(),n=t.split(e.text);n.length==2&&$("#viz-pane .words").html(n[0]+"<span class='highlighted'>"+e.text+"</span>"+n[1])}function clearSentence(e){$("#viz-pane .value").each(function(e){$(this).html($(this).data("value"))});var t=$("#viz-pane .words");t.html(t.data("text"))}var csrftoken=$.cookie("csrftoken");$.ajaxSetup({crossDomain:!1,beforeSend:function(e,t){csrfSafeMethod(t.type)||e.setRequestHeader("X-CSRFToken",csrftoken)}});$.fn.serializeObject=function(){var e={},t=this.serializeArray();$.each(t,function(){if(e[this.name]!==undefined){e[this.name].push||(e[this.name]=[e[this.name]]);e[this.name].push(this.value||"")}else e[this.name]=this.value||""});return e};var visualization_functions={};$(document).ready(function(){$(".control-viz a").click(function(e){e.preventDefault();$(".active",$(this).parents(".control-viz")).removeClass("active");$(this).parent().addClass("active")})});var graph=!1;$(document).ready(function(){$(window).resize();$("body").delegate("form","submit",function(e){e.preventDefault();var t=$(this);$("#settings-pane").hide();$("#viz-pane").show();$("input, select",t).unbind("change");$.ajax({url:t.attr("action"),type:t.attr("method"),data:t.serializeArray(),success:function(e){if(e.form){t.after(e.form);t.remove();$("#settings-pane").show();$("#viz-pane").hide()}if(e.items){graph=new Graph(e.items);graph.draw();e.nouns&&graph.setNouns(e.nouns)}e.text&&$("#viz-pane .words").data("text",e.text).html(e.text)}})}).delegate("form input,form select","change",function(){var e=$(this).parents("form");e.data("items")&&draw(e.data("items"),e.serializeObject())}).delegate("#viz-pane .close","click",function(e){e.preventDefault();$("#viz-pane").hide();$("#settings-pane").show()});$("#viz-pane").hide()});Graph.prototype.draw=function(){var e=this;$("#chart").html("");var t=$("#chart").parent();$("#chart").css({position:"fixed",top:t.position().top,left:t.position().left,width:t.width()});$("#chart").height($(window).height()-$(".navbar").height());items=generate_scores(items,settings);visualization_functions[settings.style]?e.blit=visualization_functions[settings.style](items,settings):alert("no draw funciton")};Graph.prototype.update=function(e){var t=generate_scores(this.items,e);this.blit?this.blit(t,e):alert("no update functions")};Graph.prototype.setNouns=function(e){var t=this;t.nouns=e;e.sort(function(e,t){return e.count>t.count?-1:t.count>e.count?1:e.text>t.text?-1:1});$("#nouns").html("");e.forEach(function(e){var n=e,r=$('<li class="noun" ><a href="#">'+n.text+"</a></li>").appendTo("#nouns");r.bind("click",function(e){e.preventDefault();r.toggleClass("active");var i=$("form").serializeObject();i.words=n.words;t.update(i)}).bind("mouseenter",function(e){r.toggleClass("over");var i=$("form").serializeObject();i.words=n.words;t.update(i)}).bind("mouseleave",function(e){r.toggleClass("over");var n=$("form").serializeObject();t.update(n)})})};